<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- set styles on the top -->
    <style>
      body {
        display: flex;
      }
      .chart-container {
        margin: 0 auto;
      }

      button {
          background-color: transparent;
          border: solid 1px black;
          padding: 5px 10px;
      }

      button.left {
          border-radius: 5px 0 0 5px;
          border-right: none
      }

      button.right {
          border-radius: 0 5px 5px 0;
      }

      button.active {
          background-color: darkgray;
          color: white;
          font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="chart-container">
      <h1 class="headline">Playoff Wins</h1>
      <div><button class="left update active">By Year</button><button class="right update">By Age</button><div>
      <svg width="750px" height="500px"></svg>
    </div>
  </body>

  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

  <!-- we're using d3 version 6 (the latest version) for all out work -->

  <script>
    console.log({ d3 });

    let width = 750;
    let height = 500;

    let svg = d3.select("body").select("svg");

    d3.tsv("cumulative-stats.tsv").then(function (stats) {
      d3.json("player_lookup.json").then(function (players) {
        stats.forEach((d) => {
          for (let prop in d) {
            if (!isNaN(d[prop])) {
              d[prop] = +d[prop];
            }
          }
          player = players[d.player_id];
          d.player_name = player.player_name;
          d.age = player.age_start + (d.year - player.year_start);

          d.year = new Date(d.year, 0);
        });

        let margin = { top: 30, right: 10, bottom: 10, left: 30 };

        let x = d3
          .scaleTime()
          .domain(
            d3.extent(
              stats.map(function (d) {
                return d.year;
              })
            )
          ) //d3 extent
          .range([margin.right, width - margin.left]);

        let y = d3
          .scaleLinear()
          .domain(
            d3.extent(
              stats.map(function (d) {
                return d.playoff_wins;
              })
            )
          )
          .range([height - margin.bottom, margin.top]);

        let yAxisSettings = d3
          .axisRight(y) //set axis to the left
          .tickValues([5, 10, 15, 20, 25, 30, 35]) //approx how many ticks, the function will not necesarily give you that number
          .tickSize(width - margin.left) //size of tick lines //what format do you want https://github.com/d3/d3-format
          .tickPadding(10); //distance from tick labels to tick marks

        let yAxisTicks = svg
          .append("g")
          .attr("class", "y axis")
          .call(yAxisSettings);
        //.attr("transform", `translate(${margin.right}, 0)`);

        yAxisTicks.select(".domain").attr("stroke", "none");
        yAxisTicks.selectAll(".tick line").attr("stroke", "lightgray");

        let line = d3
          .line() //define a line function
          .defined((d) => !isNaN(d.playoff_wins))
          .x(function (d) {
            return x(d.year);
          }) //accessing date
          .y(function (d) {
            return y(d.playoff_wins);
          }); //accesssing value

        let grouped_data = d3.group(stats, (d) => d.player_id);

        let highlightedQbs = [
          "BradTo00",
          "RoetBe00",
          "RodgAa00",
          "FlacJo00",
          "MahoPa00",
          "RyanMa00",
          "GarrJi00",
          "StafMa00",
          "AlleJo00",
          "PresDa00",
          "TannRy00",
        ];

        let labeledQbs = [
          "BradTo00",
          "StarBa00",
          "BradTe00",
          "TarkFr00",
          "MontJo01",
          "ElwaJo00",
        ];

        let line_path = svg
          .append("g")
          .selectAll(".line")
          .data(grouped_data)
          .join("path")
          .attr("class", function (d) {
            return "line " + d[0];
          })
          .attr("d", function (d) {
            return line(d[1]);
          })
          .style("fill", "none")
          .style("stroke", (d) => {
            if (highlightedQbs.includes(d[0])) {
              return "blue";
            } else {
              return "#999";
            }
          })
          .style("stroke-width", (d) => {
            if (d[0] == "BradTo00") {
              return "5px";
            } else {
              return "2px";
            }
          });

        let labels = svg
          .append("g")
          .selectAll("label")
          .data(grouped_data)
          .join("text")
          .attr("class", (d) => `label ${d[0]}`)
          .attr("x", (d) => x(d[1][d[1].length - 1].year))
          .attr("y", (d) => y(d[1][d[1].length - 1].playoff_wins))
          .text(
            (d) =>
              `${d[1][d[1].length - 1].player_name} (${
                d[1][d[1].length - 1].playoff_wins
              })`
          )
          .attr("dy", -10)
          .style("fill", (d) => {
            if (labeledQbs.includes(d[0])) {
              return "black";
            } else {
              return "none";
            }
          });

        let xDates = [1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020];

        let xAxisSettings = d3
          .axisBottom(x)
          .tickValues(xDates.map((year) => new Date(year, 0)))
          .tickSize(10)
          .tickPadding(10);

        let xAxisTicks = svg
          .append("g")
          .attr("class", "x axis") //give each axis a class
          .call(xAxisSettings)
          .attr("transform", `translate(0, ${height - margin.bottom})`);

        xAxisTicks.select(".domain").attr("stroke", "black");
        xAxisTicks.selectAll(".tick line").attr("stroke", "black");

        line_path.on("mouseover", (event, d) => {
          svg.select(`.label.${d[0]}`).style("fill", "black");

          if (!highlightedQbs.includes(d[0])) {
            svg.select(`.line.${d[0]}`).style("stroke", "black");
          }
        });

        line_path.on("mouseout", (event, d) => {
          if (!labeledQbs.includes(d[0])) {
            svg.select(`.label.${d[0]}`).style("fill", "none");
          }
          if (!highlightedQbs.includes(d[0])) {
            svg.select(`.line.${d[0]}`).style("stroke", "#999");
          }
        });

        let current_data = "year";
      });
    });
  </script>
</html>
